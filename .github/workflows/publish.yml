name: Zip and Upload to Chrome Web Store

on:
  push:
    branches:
      - main

jobs:
  upload-zip:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install Zip Utility
      run: sudo apt-get install zip

    - name: Zip Source Directory
      run: zip -r src.zip src

    - name: Get Access Token
      id: get-token
      run: |
        response=$(curl -s "https://oauth2.googleapis.com/token" \
          -d "client_secret=${{ secrets.CLIENT_SECRET }}" \
          -d "grant_type=refresh_token" \
          -d "refresh_token=${{ secrets.REFRESH_TOKEN }}" \
          -d "client_id=${{ secrets.CLIENT_ID }}")
        echo "token=$(echo $response | jq -r '.access_token')" >> $GITHUB_ENV

    - name: Upload Zip to Chrome Web Store
      env:
        TOKEN: ${{ env.token }}
        EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
      run: |
        curl -H "Authorization: Bearer $TOKEN" \
          -H "x-goog-api-version: 2" \
          -X PUT -T src.zip \
          -v "https://www.googleapis.com/upload/chromewebstore/v1.1/items/$EXTENSION_ID"

    - name: Publish Extension
      env:
        TOKEN: ${{ env.token }}
        EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
      run: |
        curl -H "Authorization: Bearer $TOKEN" \
          -H "x-goog-api-version: 2" \
          -H "Content-Length: 0" \
          -X POST \
          -v "https://www.googleapis.com/chromewebstore/v1.1/items/$EXTENSION_ID/publish"
